const { builtin:{types:{entity}} } = require('../index')

module.exports = function cds_infer_query (q, defs) {

	if (q.target)  return q.target

    const { SELECT, INSERT, UPDATE, DELETE } = q
    const entity = (
        SELECT ? SELECT.from.ref :
        INSERT ? INSERT.entity :
        UPDATE ? UPDATE.entity :
        DELETE ? DELETE.entity :
        _invalidQuery(q)
    )
    const target = (
        !entity ? undefined  :
        (typeof entity === 'string') ? _resolve (entity, defs)  :
        entity.name ? _resolve (entity.name, defs)  :
        entity.length>1 ? _infer (entity, defs)  :  _resolve (entity[0], defs)
    )
    Object.defineProperty (q,'target',{value:target})
    return target
}

function _infer (ref, defs) {
	let target = _resolve (ref[0], defs)
	for (let i=1; i<ref.length; ++i) {
        let a = target.elements [ref[i]] || _unresolved (target.name +':'+ref[i])
        target = a._target || _unresolved(a.target)
	}
    return target
}

function _invalidQuery() {
    throw new Error ('query is expected to be one of { SELECT | INSERT | UPDATE | DELETE }')
}
const _resolve = (x,defs) => defs[x] || (defs[x] = _unresolved(x))
const _unresolved = (x,p=entity)  => ({name:x, __proto__:p, isUnresolved:true})
