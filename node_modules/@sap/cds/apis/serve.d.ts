import { ReflectedDefinitions, ReflectedDefinition, reflected } from "./reflect";
import { ParsedModel, Definition } from "./specs/CSN";
import { ParsedQuery } from "./specs/CQN";
import { LocalService } from "./connect";

export function serve (service : string | ParsedModel) : Fluent
interface Fluent {
	from (model : string | ParsedModel) : this
	to (protocol: string) : this
	at (path: string) : this
	in (app: express.app) : this
	with (impl: ServiceImpl | string) : this
	then (next: ()=> void) : Promise<ServiceProvider | ServiceProviders>
	catch (handler: (err)=> void) : Promise<void>
}

declare namespace express {
	interface app {}
}

export const service : {
	impl: (impl: ServiceImpl) => typeof impl
}

export type ServiceDefinition = ReflectedDefinition

export type ServiceProviders = { [name:string]: ServiceProvider }

export interface ServiceProvider extends LocalService {
	entities : typeof reflected.entities
	on (op: Method, entity?: Target, handler?: RequestHandler) : this
	before (op: Method, entity?: Target, handler?: RequestHandler) : this
	after (op: Method, entity?: Target, handler?: ResultsHandler) : this
	reject (ops: CRUD | CRUD[], ...entity: Target[]) : this
	handle (query : ParsedQuery)
}

/**
 * A service implementation function.
 * @param entities - the current service's entity definitions
 * @param this - the current ServiceProvider
 */
export interface ServiceImpl {
	( this: ServiceProvider, entities: ReflectedDefinitions )
}

type Target = Definition
type Method = CRUD | TX | HTTP // | CustomOp
type CRUD = 'CREATE' | 'READ' | 'UPDATE' | 'DELETE'
type HTTP = 'GET' | 'PUT' | 'POST' | 'DELETE' | 'PATCH'
type TX = 'COMMIT' | 'ROLLBACK'
type CustomOp = string


interface RequestHandler {
	(req : Request) : Promise<any> | any | void
}
interface ResultsHandler {
	(results : any[])
	(each : any)
}

type Request = {
	query
	target
	reply()
	error()
	reject()
}