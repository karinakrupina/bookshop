module.exports = Object.assign (load, {only:get})
const cdsv = require('./cdsv')
const path = require('path')

function load (model, options) {
  const m = _loadCollectedSources (model, options); if (m)  return m // REVISIT: remove that
  const all = this.resolve (model); if (!all) return notFound (model)
  return cdsv.compile (all, undefined, options)
}

function get (model) {
  const all = this.resolve(model); if (!all) return notFound (model)
  if (all.length > 1) throw new Error(`You can only cds.get a single model`)
  return cdsv.compile (all, undefined, {parseOnly: true})
}

// TODO: wir mÃ¼ssen das loswerden
function _loadCollectedSources (file, options) {
  if (Array.isArray(file) && file.length === 1) [file] = file
  if (typeof file !== 'string' || path.parse(file).base !== 'csn.json') return
  const collectedSources = require(path.resolve(file))
  const parsed = cdsv.parse (collectedSources, options)
  let srv = collectedSources.srv
  if (srv) {
    if (!srv.endsWith(path.sep))  srv += path.sep
    for (let each in parsed.definitions) {
      let d = parsed.definitions[each], src = d['@source']
      if (src)  d['@source'] = src.replace(srv,'')
    }
  }
  parsed._sources.splice(0, parsed._sources.length, file)
  return Promise.resolve(parsed)
}

function notFound (model) {
  return Promise.reject(Object.assign(new Error(`Couldn't find a CDS model at: ${_local(model)}`), {
    code: 'MODEL_NOT_FOUND', model
  }))
}

const _cwd = process.cwd() + require('path').sep
const _local = (path) => ('' + path).replace(_cwd, '')
