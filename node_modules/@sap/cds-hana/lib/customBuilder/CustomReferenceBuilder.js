const ReferenceBuilder = require('@sap/cds-sql').builder.ReferenceBuilder

class CustomReferenceBuilder extends ReferenceBuilder {
  get SelectBuilder () {
    const SelectBuilder = require('./CustomSelectBuilder')
    Object.defineProperty(this, 'SelectBuilder', { value: SelectBuilder })
    return SelectBuilder
  }

  _handleContains () {
    const contains = !this._obj.ref[0].toLowerCase().includes('not')
    const columnsString = `(${this._columnsFromContains(this._obj.ref[1].args).join(', ')})`
    this._outputObj.sql.push(
      `${contains ? '' : 'NOT '}CONTAINS(`,
      `${columnsString},`,
      `${this._options.placeholder},`,
      'FUZZY(0.9)',
      ')'
    )

    const params = this._obj.ref[1].args.slice(1)
    let searchTerm = ''

    for (const param of params) {
      if (param.val) {
        searchTerm = `${searchTerm}"${param.val.replace(/(%|\?|\*)/g, '\\$1')}"`
      } else if (param === 'and') {
        searchTerm = `${searchTerm} `
      } else if (param === 'or') {
        searchTerm = `${searchTerm} OR `
      } else {
        // param === 'not'
        searchTerm = `${searchTerm}-`
      }
    }

    this._outputObj.values.push(searchTerm)
  }
}

module.exports = CustomReferenceBuilder
