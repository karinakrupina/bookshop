const { DB_CONNECTION_MISSING } = require('../utils/constants')
const { getSelectCQN, checkNotNull } = require('../utils/handlerUtils')

/**
 * Generic Handler for CREATE requests.
 * In case of success it returns the created entry.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onCreate
 */
const onCreate = () => context => {
  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return Promise.resolve(context.data)
  }
  // Checks if entry is already created
  return context.run(getSelectCQN(context, [1])).then(result => {
    // If entry is available, throw error
    if (result.length !== 0) {
      context.reject(400, 'Entity Already Exists')
    }

    if (checkNotNull(context)) {
      return context.data
    }

    return context.run(context.query).then(() => {
      return context.data
    })
  })
}

module.exports = onCreate
