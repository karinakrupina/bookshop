const getContextObject = require('../utils/context-object')
const { parseUpdateUrl } = require('../utils/parse-url')
const handleError = require('../utils/handle-error')
const validationChecks = require('../utils/validation-checks')

const update = service => {
  return (req, res) => {
    let parsedUrl
    try {
      parsedUrl = parseUpdateUrl(service.entities, req)
    } catch (err) {
      return handleError(err, service, res)
    }

    const context = getContextObject(service, parsedUrl, req, res)
    const err = validationChecks(context.target, context.data)
    if (err) return handleError(err, service, res)

    return service
      .processEvent('UPDATE', context)
      .then(result => {
        res.status(200)
        res.send(result[0])
      })
      .catch(err => {
        // Hide errors in generic message but log detailed error
        handleError(err, service, res)
      })
  }
}

module.exports = update
