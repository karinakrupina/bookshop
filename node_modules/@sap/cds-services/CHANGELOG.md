# Changelog

All notable changes to this project will be documented in this file.

This project adheres to [Semantic Versioning](http://semver.org/).

The format is based on [Keep a Changelog](http://keepachangelog.com/).

## Version 1.5.2 - 2019-02-13

### Added

 - Support for sql functions lower, upper, trim, length in $filter and $orderby

### Changed

- Sync functions at before and after handler are not wrapped in promise anymore
- req.reject does not throw anymore
- @sap/audit-logging only used in case the service is provided via VCAP_SERVICES
- Unknown query parameters are not longer rejected at REST adapter

### Fixed

- OData version for $metadata
- Multiple atomicity groups should not share same transaction block
- Brackets in $filter now work correctly

## Version 1.5.1 - 2019-02-12

### Changed

- @sap/audit-logging only used in case the service is provided via VCAP_SERVICES

### Fixed

- No integrity checks when running without db connection


## Version 1.5.0 - 2019-02-07

### Added

- Set foreign keys for POST via `navigation-to-many` and modeled with `$self`
- Support `content id` placeholders in odata v4 batch requests
- Support complex cases at security annotations

### Changed

- Referential integrity checks do not run for associations with specified on conditions
- Rest adapter now ignores query parameters
- Minimum node version 8.9.0
- `.data` and `.query` can be overwritten

### Fixed

- Insert with excluded properties having default values
- Delete active documents in a draft-enabled service without a draft
- Path segment `/$count` respects `$filter`

## Version 1.4.0 - 2019-01-22

### Added

- When registering service handlers, entities can be given as a list
- Support requests to /SiblingEntity in draft
- Annotation `@cds.integrity.skip` to disable reference integrity checks (experimental!)

### Changed

- Replaced @sap/odata-v4 by @sap/odata-server

## Version 1.3.0 - 2019-01-11

### Added

- Authorization filtering and user attributes as lists
- Referential integrity checks

### Fixed

- No fallback for user identifier in case the user object is empty
- Reading draft administrative data

## Version 1.2.0 - 2018-12-21

### Added

- Set default values in case of CREATE, UPSERT and adding a child in deep documents

### Changed

- `context.draftMetadata` contains draft metadata
- `context.isDraftChange` indicates only changes in drafts
- Error messages to be more consistent

### Fixed

- On handler registration for custom handlers in draft
- Draft children can be deleted without navigations
- Reading all draft-enabled documents takes into account only own drafts

### Removed

## Version 1.1.0 - 2018-12-12

### Added

- Deep Document Calls (deep insert, deep update and cascade delete)
- `context.draft` contains draftUUID in case of Create, Update or Delete
- filter and orderby with navigation

### Changed

- improved error messages

- Activating a draft now triggers the 'UPDATE' or 'CREATE' event

### Fixed

- Create Draft uses default values
- draftActivate uses correct keys for update
- $count in draft context now calculates correct result
- db view with select
- Support for navigation over draft with count
- .code property of Errors in Custom handlers will not be overwritten

## Version 1.0.0 - 2018-11-27

### Added

- Support for now function in $filter
- Support for authorization annotations CREATE, UPDATE, DELETE
- Conversion of cds.DateTime/Timestamp using UTC
- Entity definition at service as select view

### Changed

- Update entry makes insert if the entry doesn't exist 
- Log messages are used directly instead of being wrapped
- Bound functions now have a query value
- Function next is implicitly executed in synchronous on-handlers
- Improved error handling
- Handler registration allows following variations:
    - Array of events: e.g. ['READ', 'UPDATE']
    - '*' wildcard for any entity event
- next() throws error if called twice in same handler
- Custom implementation must be provided via .with
- Renamed service.definition to service.model
- Renamed service.service to service.name
- updated odata-v4 version to 1.8.0
- Location header for draft actions is now relative

### Fixed

- POST on existing entity throws 'Bad Request'
- $search and $filter in combination with some read draft cases
- POST with navigation does not create a new key
- Access restriction on service level
- UPDATE sql statement generated wrong for entity with multiple keys
- Access to user's locale
- draftEdit action on entities without children
- CREATE with not nullable elements

## Version 0.12.0 - 2018-10-17

### Added

- Custom handlers can be registered and executed for bound functions and function imports
- Added BeforeCreate and BeforeCreateDraft handlers to generate needed UUIDs

### Changed

- Removed translator in the insert based on where by instanced based authorization
- Removed internal event rejections
- Not found error message generalized for reading through navigation
- Refactoring and changes due to updated dependencies

## Version 0.11.0 - 2018-10-04

### Added

- Generic support for Create, Update, Delete on draft-enabled entities
- Generic support for draftEdit, draftPrepare, draftActivate actions
- Logger is available in handlers via context.log

### Changed

- Log warning if database connection is missing

### Fixed

- Service requests now return promises instead of thenables

## Version 0.10.1 - 2018-09-18

### Added

- Generic support for Read on draft-enabled entities

### Fixed

- $user annotation works without authorization

## Version 0.10.0 - 2018-09-17

### Added

- Delete Draft
- Audit Logging of GDPR related events
- Auto lookup of to be used CF/XSA services from environmental VCAP_SERVICES
- OData to context.query for nested $filter, $orderby, $op and $skip at $expand
- Custom types on top of associations

### Changed

- Default for maxPageSize increased to 1000 from 100

### Fixed

- Values for annotated columns (user/now) are included in the response

## Version 0.9.2 - 2018-09-05

### Changed

- Improved npm-shrinkwrap

## Version 0.9.1 - 2018-09-03

### Added

- Create draft

### Removed

- implicit dependency to @sap/cds-sql

## Version 0.9.0 - 2018-08-28

### Added

- API to support the implementation of authorization restrictions 
- Local service client
- Support for to-one-navigation in $filter
- Support for annotation @Search.defaultSearchElement to restrict searchable columns in $search
- Support for sap-language query parameter
- Support authorization annotations
- Hooks to add custom logic before and after rollback event
- Audit Logging of security events

### Fixed

- Pagination in case of $expand
- $select with managed associations as key

## Version 0.8.1 - 2018-08-09

### Added

- Authentication using passport (including user/attr proxy)

### Changed

- Require submodules on demand

## Version 0.8.0 - 2018-08-07

### Added

- OData Service: $search supports Unary and Binary Expressions without brackets
- Registration of global handler using star symbol like "this.on('*', () => {})"   
- Registration of express middleware using this.use()
- Improved FeautureNotSupported error message
- context.reject supported for before, on and after handlers 
- Support of context.run().then.run() shortcut

### Changed

- Updated version of @sap/odata-v4 to ^1.6.0

### Fixed

- Localization in case language is changed
- Issue with not working $count when filtering active in custom hook

## Version 0.7.0 - 2018-07-11

### Added

- Localization support for $metadata
- Support for Compositions

### Fixed

- $search also considers foreign keys of managed associations, structured elements and complex types

## Version 0.6.0 - 2018-07-02

### Added

- Multi tenancy support

### Fixed

- Columns are only added once to CQN in case of $expand in combination with $select

## Version 0.5.0 - 2018-06-25

### Added

- Hooks
  - An any handler can be registered and will be executed for any but COMMIT events
  - Custom handlers can be registered for before COMMIT and after COMMIT events
  - "_" property added to cds handler argument, which can contain adapter specific data like a request object

- OData Service
  - $filter supports (not) contains, startsWith, endsWith
  - $filter supports combinations with and/or
  - $select within $expand
  - $apply supported with limited scope
  - $search supported with limited scope

### Changed

- Hooks
  - Undocumented OData specific properties removed from "cds" handler argument
  - cds.target contains the unreflected entity instead of the reflected entity
  - cds.error will collect errors and throw at the end of each block of .before, .on or .after handlers
  - Second call to next() at a on handler will be ignored and not break the sequence

### Fixed

- Support navigation over entities with multiple keys

### Removed

- In case of a SerializationError the details are only logged and not provided in the response anymore

## Version 0.4.1 - 2018-05-03

### Changed

- Updated version of @sap/cds-ql to 0.4.1

## Version 0.4.0 - 2018-05-02

### Added

- service factory
  - cds used via injection

- Hooks
  - Support annotations @insertonly and @readonly
  - Support reject registration for CSN entities
  - Support reject registration with multiple entity parameters

### Changed

- default logger uses matching methods from console object instead of console.log
- packages are loaded on demand at Services.js and OData.js instead of required in any case
- adapted error message in case of 501

## Version 0.3.0 - 2018-04-16
### Added

- service factory
  - service.entities is set

- OData Service
  - Support for $expand=*
  - Support for $select=*

- Hooks
  - CSN entities can be used instead of strings to register a handler
  - .on can be registered with CQN instead of function as handler
  - .on supports registering N handlers
  - .on handlers can use a second argument next()
  - .on can be finished by returning a value
  - .after with convenience wrappers for each|row argument
  - .after can now work asynchronously


### Changed

- server side paging is enabled by default and set to 100, to disable it set maxPageSize to false.

- refactored service factory
  - removed option to compile CSN on the fly, only CSN accepted as input format
  - option to set the URL path is removed
  - Multi service CSN can be used

- refactored Service class
  - OData service instantiation is now split in constructor, createODataService and getMiddleWare

- OData Service
  - Renamed parameters in handler context object (target replaces entity and getEntity)
  - More expressive error messages
  - Crash Node.js instance on unhandled error

### Fixed

- limit property is only added to CQN if necessary
- .reply() is able to handle null values

## Version 0.2.0 - 2018-03-16
### Added

- option to enable debug mode for odata-v4
- default logger with option to register custom logger
- support for server side paging
- support for cds.serve, which is a Fluent API-style method to read service definitions from the given model(s) and construct services
- usage of npm-shrinkwrap

### Fixed

- $filter in combination with to many association
