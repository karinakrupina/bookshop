const BaseStatement = require('./BaseStatement')
const { IllegalFunctionArgumentError, HasBeenCalledError } = require('../errors')

/**
 * CREATE statement creates entity
 */
class Create extends BaseStatement {
  constructor () {
    super('CREATE')
  }

  /**
   * @param {string|object} entity - entity name or an entity from reflection API
   * @param {object} elements - dictionary as specified in CSN element definition
   */
  static entity (entity, elements) {
    BaseStatement._isEntity(entity)

    const cqn = new Create()

    if (elements) {
      cqn.CREATE.entity = { elements: elements, kind: 'entity', name: entity }
    } else {
      cqn.CREATE.entity = entity
    }

    return cqn
  }

  /**
   * Constructs a create statement as SELECT.from statement
   * @param {object} query - SELECT query
   * @example
   * CREATE.entity('Bar').as(SELECT.from('Foo'))
   * @throws HasBeenCalledError - if called twice
   * @throws IllegalFunctionArgumentError - if query is not of expected format
   *
   */
  as (query) {
    if (!query || !query.SELECT) {
      throw new IllegalFunctionArgumentError('query')
    }

    if (this.CREATE.as) {
      throw new HasBeenCalledError('as')
    }

    this.CREATE.as = query
    return this
  }
}

module.exports = Create
